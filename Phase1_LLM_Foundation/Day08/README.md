# Day 08: A/B测试实验设计

## 🎯 1. 核心风险与测试目标

### 1.1 测试工程师视角
> **核心原则**：开发只管跑通，我们要想办法把它搞崩溃。A/B测试不是"试试看哪个好"，而是"用统计学证明哪个更好"。没有严格实验设计的A/B测试就是伪科学。

### 1.2 业务风险点

| 风险类别 | 具体风险 | 线上事故场景 |
|---------|---------|-------------|
| **样本不足** | 测试流量太小，结果无统计显著性 | 误判新版本更好，全量后发现问题 |
| **实验污染** | 对照组和实验组用户相互影响 | 实验组功能影响对照组用户体验 |
| **选择偏差** | 分组不均匀，两组用户特征差异大 | 结果不可比，决策依据错误 |
| **过早停止** | 实验未达到最小样本量就下结论 | 假阳性/假阴性错误，错误决策 |
| **多重比较** | 同时测试多个指标，偶然显著 | 某个指标偶然"显著"就发布 |
| **网络效应** | 用户间相互影响（社交场景） | 实验组用户影响对照组，结果失真 |

### 1.3 测试思路

**A/B测试实验设计策略**：
- **随机化分组**：确保用户随机分配，避免选择偏差
- **样本量计算**：基于MDE（最小可检测效应）计算所需样本量
- **实验时长规划**：考虑周期性（工作日vs周末），避免时间偏差
- **多重检验校正**：Bonferroni校正或FDR控制，降低假阳性率
- **护栏指标**：设置必须保护的指标（如错误率），退化即停止

**统计检验策略**：
- **T检验/Z检验**：连续指标（延迟、准确率）差异检验
- **卡方检验**：分类指标（转化率、点击率）差异检验
- **Bootstrap**：非参数检验，不假设分布
- **序贯检验**：支持提前停止，减少实验时长

**实验监控策略**：
- **实时SRM检查**：样本比例不匹配检测，发现分组问题
- **护栏指标告警**：核心指标退化立即告警
- **实验健康度**：样本充足性、随机化质量、数据完整性

---

## 📚 2. A/B测试实验设计原理（测试必备知识）

### 2.1 为什么需要严格实验设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    无实验设计 vs 有实验设计对比                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  无实验设计（拍脑袋决策）                                         │
│  ───────────────────────                                         │
│  产品经理: "新模型上线后，用户反馈好像变好了"                     │
│  数据分析师: "过去一周的投诉率确实下降了"                         │
│  决策: "那就全量发布吧"                                          │
│  结果: 3周后发现转化率其实下降了5%，只是巧合                      │
│                                                                 │
│  有实验设计（科学决策）                                           │
│  ─────────────────────                                           │
│  产品经理: "新模型A/B测试，实验组转化率提升2.5%"                  │
│  数据分析师: "样本量充足(n=10000)，p-value=0.003，统计显著"       │
│  统计功效: 80% (β=0.2)                                           │
│  决策: "统计证明新版本显著优于对照组，可以全量"                   │
│  结果: 全量后转化率确实提升2.3%，与实验预期一致                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 A/B测试核心统计概念

| 概念 | 说明 | 公式/标准 |
|-----|------|----------|
| **显著性水平(α)** | 假阳性概率阈值 | 通常设为0.05 |
| **统计功效(1-β)** | 正确拒绝原假设的概率 | 通常设为0.8 |
| **MDE** | 最小可检测效应 | 业务关心的最小改善幅度 |
| **样本量(n)** | 每组所需用户数 | 由α、β、MDE、方差决定 |
| **置信区间** | 估计值的不确定性范围 | 95% CI = 估计值 ± 1.96×SE |
| **p-value** | 观察到当前结果的概率 | < α则拒绝原假设 |

### 2.3 样本量计算原理

```python
# 样本量计算核心逻辑

class SampleSizeCalculator:
    """样本量计算器"""
    
    def calculate_continuous(self, baseline_mean: float, 
                            baseline_std: float,
                            mde: float,
                            alpha: float = 0.05,
                            power: float = 0.8) -> int:
        """
        连续指标样本量计算
        
        公式: n = 2 * (Z_(1-α/2) + Z_power)² * σ² / MDE²
        
        Args:
            baseline_mean: 对照组均值
            baseline_std: 对照组标准差
            mde: 最小可检测效应（绝对值或相对值）
            alpha: 显著性水平
            power: 统计功效
        """
        from scipy import stats
        
        z_alpha = stats.norm.ppf(1 - alpha/2)  # 双侧检验
        z_beta = stats.norm.ppf(power)
        
        # 合并方差（假设两组方差相等）
        pooled_variance = 2 * baseline_std ** 2
        
        n = (z_alpha + z_beta) ** 2 * pooled_variance / (mde ** 2)
        
        return int(np.ceil(n))
    
    def calculate_proportion(self, baseline_rate: float,
                            mde_relative: float,
                            alpha: float = 0.05,
                            power: float = 0.8) -> int:
        """
        比例指标样本量计算
        
        公式: n = (Z_(1-α/2)√(2p(1-p)) + Z_power√(p₁(1-p₁)+p₂(1-p₂)))² / (p₁-p₂)²
        
        Args:
            baseline_rate: 对照组转化率
            mde_relative: 相对MDE（如0.1表示提升10%）
        """
        from scipy import stats
        
        p1 = baseline_rate
        p2 = baseline_rate * (1 + mde_relative)
        
        z_alpha = stats.norm.ppf(1 - alpha/2)
        z_beta = stats.norm.ppf(power)
        
        p_pooled = (p1 + p2) / 2
        
        numerator = (z_alpha * np.sqrt(2 * p_pooled * (1 - p_pooled)) + 
                    z_beta * np.sqrt(p1 * (1 - p1) + p2 * (1 - p2))) ** 2
        denominator = (p1 - p2) ** 2
        
        n = numerator / denominator
        
        return int(np.ceil(n))
```

### 2.4 实验设计检查清单

```
┌─────────────────────────────────────────────────────────────────┐
│                      A/B测试实验设计检查清单                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 假设定义                                                      │
│     □ 零假设(H0): 新版本与对照组无差异                            │
│     □ 备择假设(H1): 新版本显著优于/劣于对照组                      │
│     □ 单侧检验还是双侧检验？                                       │
│                                                                 │
│  2. 样本量规划                                                    │
│     □ 计算每组所需样本量                                          │
│     □ 考虑20%流失率，增加样本量                                   │
│     □ 确定实验运行时长（考虑周期性）                               │
│                                                                 │
│  3. 随机化策略                                                    │
│     □ 用户ID哈希随机化                                            │
│     □ 流量分配比例（50:50还是80:20）                              │
│     □ 分层随机化（按用户属性分层）                                 │
│                                                                 │
│  4. 指标定义                                                      │
│     □ 主要指标（决定实验成败）                                    │
│     □ 次要指标（辅助决策）                                        │
│     □ 护栏指标（必须保护的指标）                                  │
│                                                                 │
│  5. 分析方法                                                      │
│     □ 统计检验方法（T检验/卡方检验）                              │
│     □ 多重比较校正                                                │
│     □ 置信区间计算                                                │
│                                                                 │
│  6. 停止规则                                                      │
│     □ 最小样本量达到后才可分析                                    │
│     □ 护栏指标退化立即停止                                        │
│     □ 序贯检验支持提前停止                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🧪 3. 实验验证任务

请运行本目录下的 `test_day08.py`，观察以下关键输出：

### 3.1 样本量计算验证
- 连续指标样本量计算（准确率、延迟）
- 比例指标样本量计算（转化率、通过率）
- MDE敏感性分析

### 3.2 随机化分组验证
- 用户哈希随机化一致性
- 分组比例平衡性检验
- 分层随机化效果

### 3.3 统计检验验证
- T检验/Z检验正确性
- 卡方检验正确性
- 多重比较校正效果

### 3.4 实验健康度监控
- SRM（样本比例不匹配）检测
- 护栏指标监控
- 实验提前停止决策

---

## 📝 4. 产出要求

将运行结果贴回给 Trae，让其生成 `report_day08.md` 质量分析报告。

报告应包含：
1. **样本量计算报告**：不同指标所需样本量、实验时长规划
2. **随机化质量报告**：分组平衡性、SRM检测结果
3. **统计检验结果**：显著性检验结果、置信区间、效应量
4. **实验决策建议**：是否达到统计显著、是否可提前停止、是否可发布
