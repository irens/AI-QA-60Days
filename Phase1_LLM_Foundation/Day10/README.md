# Day 10: 知识图谱验证与结构化事实核查

## 🎯 1. 核心风险与测试目标

### 1.1 测试工程师视角
> **核心原则**：开发只管跑通，我们要想办法把它搞崩溃。NLI检测只能发现"明显矛盾"，但**知识图谱能发现"隐形错误"**——那些看似合理、实则与结构化知识冲突的微妙幻觉。

### 1.2 业务风险点

| 风险类别 | 具体风险 | 线上事故场景 |
|---------|---------|-------------|
| **关系错误** | 实体间关系与知识图谱不符 | 医疗AI错误关联"药物A-禁忌症B"，导致用药事故 |
| **属性错误** | 实体属性值与知识库冲突 | 金融AI给出错误的公司成立时间，影响投资决策 |
| **类型错误** | 实体类型分类错误 | 法律AI将"判例"误分类为"法规"，引用错误 |
| **时效错误** | 使用过期的知识版本 | 客服AI引用已废止的收费标准，引发客诉 |
| **上下文混淆** | 同名实体未正确消歧 | 提到"苹果"时混淆公司与水果，回答错误 |

### 1.3 测试思路

**知识图谱验证策略**：
- **实体链接**：将文本提及链接到知识图谱标准实体
- **关系验证**：验证声明的关系是否存在于知识图谱
- **属性核查**：对比实体属性值与知识库记录
- **时效校验**：检查知识版本是否在有效期内
- **消歧验证**：确保同名实体上下文正确

**结构化事实核查策略**：
- **SPARQL查询**：将声明转换为结构化查询验证
- **路径验证**：验证实体间路径是否符合知识图谱
- **规则引擎**：基于业务规则验证事实合理性
- **版本控制**：追踪知识更新，检测过期声明

---

## 📚 2. 知识图谱验证原理（测试必备知识）

### 2.1 为什么需要知识图谱验证

```
┌─────────────────────────────────────────────────────────────────┐
│              NLI检测 vs 知识图谱验证对比                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  NLI检测的盲区                                                   │
│  ───────────────                                                 │
│  参考："爱因斯坦获得诺贝尔物理学奖"                              │
│  回答："爱因斯坦获得诺贝尔和平奖"                                │
│  NLI结果：矛盾 ✅ 能检测                                          │
│                                                                 │
│  回答："爱因斯坦于1905年获得诺贝尔奖"                            │
│  NLI结果：中立 ⚠️ 无法检测（无矛盾词汇）                          │
│  实际：错误！获奖年份是1921年                                     │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  知识图谱验证的优势                                              │
│  ─────────────────                                               │
│  知识图谱：爱因斯坦 --获奖年份--> 1921                            │
│  声明：爱因斯坦于1905年获得诺贝尔奖                               │
│  验证：1905 ≠ 1921 ❌ 检测到错误                                  │
│                                                                 │
│  知识图谱还能检测：                                              │
│  • 关系方向错误（A治愈B vs B治愈A）                               │
│  • 属性范围错误（人口数量>100亿）                                  │
│  • 类型错误（人 vs 公司）                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 知识图谱验证核心流程

```python
# 知识图谱验证核心逻辑

class KnowledgeGraphVerifier:
    """知识图谱验证器"""
    
    def verify(self, claim: str) -> VerificationResult:
        """
        验证声明与知识图谱的一致性
        
        步骤：
        1. 实体识别与链接
        2. 关系抽取
        3. 知识图谱查询
        4. 一致性判断
        """
        # Step 1: 实体识别
        entities = self.extract_entities(claim)
        
        # Step 2: 实体链接到知识图谱
        linked_entities = []
        for entity in entities:
            kg_entity = self.link_to_kg(entity)
            linked_entities.append(kg_entity)
        
        # Step 3: 关系抽取与验证
        relations = self.extract_relations(claim, linked_entities)
        
        # Step 4: 知识图谱查询验证
        verification_results = []
        for relation in relations:
            kg_fact = self.query_kg(relation)
            is_valid = self.compare_with_kg(relation, kg_fact)
            verification_results.append({
                "relation": relation,
                "kg_fact": kg_fact,
                "is_valid": is_valid
            })
        
        return VerificationResult(results=verification_results)
```

### 2.3 实体链接（Entity Linking）

实体链接是将文本中的提及映射到知识图谱标准实体的过程：

| 步骤 | 说明 | 示例 |
|------|------|------|
| **提及检测** | 识别文本中的实体提及 | "爱因斯坦获得诺贝尔奖" |
| **候选生成** | 生成可能的实体候选 | 阿尔伯特·爱因斯坦、爱因斯坦（公司）... |
| **消歧排序** | 根据上下文选择最可能实体 | 物理学家爱因斯坦 |
| **链接确认** | 确认链接置信度 | 置信度0.95 |

```python
# 实体链接示例

def link_entity(mention: str, context: str, kg: KnowledgeGraph) -> EntityLink:
    """
    将提及链接到知识图谱实体
    """
    # 1. 候选生成
    candidates = kg.search_candidates(mention)
    # 返回：[爱因斯坦(物理学家), 爱因斯坦(公司), 爱因斯坦(地名)...]
    
    # 2. 上下文消歧
    for candidate in candidates:
        candidate.context_score = calculate_similarity(
            context, 
            candidate.description
        )
    
    # 3. 选择最佳匹配
    best_match = max(candidates, key=lambda c: c.context_score)
    
    return EntityLink(
        mention=mention,
        entity_id=best_match.id,
        entity_name=best_match.name,
        confidence=best_match.context_score,
        entity_type=best_match.type
    )
```

### 2.4 关系验证模式

知识图谱验证支持多种关系验证模式：

```
┌─────────────────────────────────────────────────────────────────┐
│                      关系验证模式                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 直接关系验证                                                │
│     声明："爱因斯坦获得诺贝尔奖"                                 │
│     查询：SELECT ?award WHERE {                                  │
│               :Einstein :received ?award .                       │
│               ?award rdf:type :NobelPrize .                      │
│            }                                                     │
│     结果：验证通过 ✅                                            │
│                                                                 │
│  2. 属性值验证                                                  │
│     声明："爱因斯坦出生于1879年"                                 │
│     查询：SELECT ?birthYear WHERE {                              │
│               :Einstein :birthYear ?birthYear .                  │
│            }                                                     │
│     对比：?birthYear == 1879 ✅                                  │
│                                                                 │
│  3. 路径验证                                                    │
│     声明："爱因斯坦和玻尔都是量子力学先驱"                        │
│     查询：ASK WHERE {                                            │
│               :Einstein (:contributedTo/:field) :QuantumMechanics│
│               :Bohr (:contributedTo/:field) :QuantumMechanics    │
│            }                                                     │
│     结果：验证通过 ✅                                            │
│                                                                 │
│  4. 反向关系验证                                                │
│     声明："诺贝尔奖授予爱因斯坦"                                 │
│     查询：验证 :NobelPrize :awardedTo :Einstein                  │
│     注意：关系方向与声明相反，需双向验证                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.5 验证结果分类

| 结果类型 | 含义 | 处理建议 |
|---------|------|---------|
| **CONFIRMED** | 知识图谱明确支持 | ✅ 可信 |
| **CONTRADICTED** | 知识图谱明确否定 | ❌ 幻觉，需拦截 |
| **UNKNOWN** | 知识图谱无记录 | ⚠️ 无法验证，需其他手段 |
| **AMBIGUOUS** | 实体消歧不确定 | ⚠️ 需人工确认 |
| **OUTDATED** | 知识版本过期 | ⚠️ 需更新知识库 |

---

## 🧪 3. 实验验证任务

请运行本目录下的 `test_day10.py`，观察以下关键输出：

### 3.1 实体链接验证
- 文本提及识别
- 候选实体生成
- 上下文消歧
- 链接置信度评估

### 3.2 关系验证验证
- 直接关系查询
- 属性值对比
- 路径存在性验证
- 反向关系检测

### 3.3 时效性验证
- 知识版本检查
- 过期声明检测
- 更新频率监控

### 3.4 综合验证流程
- 端到端声明验证
- 多维度验证结果汇总
- 风险等级评估

---

## 📝 4. 产出要求

将运行结果贴回给 Trae，让其生成 `report_day10.md` 质量分析报告。

报告应包含：
1. **实体链接质量报告**：链接准确率、消歧成功率
2. **关系验证结果**：各类关系的验证通过率
3. **知识覆盖度分析**：KNOWN/UNKNOWN/CONTRADICTED分布
4. **时效性评估**：知识版本新鲜度
5. **改进建议**：知识图谱优化方向
