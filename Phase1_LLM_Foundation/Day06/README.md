# Day 06: 输出稳定性基线建立与漂移检测

## 🎯 1. 核心风险与测试目标

### 1.1 测试工程师视角
> **核心原则**：开发只管跑通，我们要想办法把它搞崩溃。没有基线的稳定性测试都是耍流氓——你无法检测"变化"，除非你首先定义"正常"。

### 1.2 业务风险点

| 风险类别 | 具体风险 | 线上事故场景 |
|---------|---------|-------------|
| **基线缺失** | 未建立输出稳定性基线，无法识别异常 | 模型输出逐渐漂移，数周后才被发现，用户流失 |
| **漂移误判** | 将正常波动误判为异常，或反之 | 频繁误告警导致告警疲劳，真实问题被忽略 |
| **回归失效** | 模型更新后未进行稳定性回归测试 | 新版本上线后输出质量断崖式下跌 |
| **阈值僵化** | 使用固定阈值无法适应业务变化 | 业务淡季和旺季使用同一阈值，误报率飙升 |
| **监控盲区** | 只监控均值忽略分布形态变化 | 输出均值不变但方差增大，用户体验恶化 |

### 1.3 测试思路

**基线建立策略**：
- **黄金数据集**：选择50-100个代表性Prompt作为稳定性测试基准
- **多维度采样**：覆盖不同业务场景、不同复杂度、不同语言类型
- **统计基线**：记录输出长度、响应时间、多样性分数的分布特征
- **快照机制**：保存预期输出范围，而非单一预期输出

**漂移检测策略**：
- **统计检验**：使用KS检验、卡方检验检测分布漂移
- **距离度量**：余弦相似度、Jaccard距离、编辑距离量化变化
- **时间窗口**：滑动窗口 vs 固定窗口的对比分析
- **自适应阈值**：基于历史数据动态调整告警阈值

**异常模式识别**：
- **均值漂移**：输出中心趋势发生偏移
- **方差膨胀**：输出稳定性下降，波动增大
- **分布变形**：从单峰变为多峰，或出现长尾
- **相关性断裂**：输入-输出关联模式改变

---

## 📚 2. 稳定性基线原理（测试必备知识）

### 2.1 为什么需要稳定性基线

```
┌─────────────────────────────────────────────────────────────────┐
│                    无基线 vs 有基线对比                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  无基线场景（灾难）                                               │
│  ─────────────────                                               │
│  Week 1: 输出质量 95% ──→ 开发:"很好"                           │
│  Week 2: 输出质量 90% ──→ 开发:"正常波动"                       │
│  Week 3: 输出质量 85% ──→ 开发:"可能有点问题"                    │
│  Week 4: 输出质量 70% ──→ 用户投诉激增 🔥                        │
│                                                                 │
│  有基线场景（可控）                                               │
│  ─────────────────                                               │
│  基线: 输出质量 95% ± 3% (基于1000次测试建立)                    │
│                                                                 │
│  Week 1: 输出质量 95% ──→ 系统:"正常" ✅                        │
│  Week 2: 输出质量 90% ──→ 系统:"低于基线-2σ，告警" ⚠️           │
│  Week 3: 输出质量 85% ──→ 系统:"严重偏离，启动回滚" 🔴          │
│  Week 4: 输出质量 70% ──→ 系统:"已自动回滚至上一版本" 🛡️        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 稳定性基线核心指标

| 指标类别 | 具体指标 | 计算方法 | 业务含义 |
|---------|---------|---------|---------|
| **输出长度** | 平均长度、长度方差、长度分布 | 字符数/Token数统计 | 输出完整性变化 |
| **响应时间** | P50、P95、P99延迟 | 百分位数统计 | 服务性能退化 |
| **语义稳定性** | 输出相似度、多样性分数 | 嵌入向量余弦相似度 | 内容一致性 |
| **结构稳定性** | JSON格式合规率、字段完整率 | Schema验证 | 结构化输出可靠性 |
| **分布特征** | 偏度、峰度、熵值 | 统计学方法 | 输出模式变化 |

### 2.3 漂移检测算法

```python
# 核心漂移检测逻辑

class DriftDetector:
    """漂移检测器"""
    
    def detect_mean_drift(self, baseline_mean, current_mean, threshold=0.1):
        """
        均值漂移检测
        
        原理：当前均值偏离基线均值超过阈值时触发告警
        """
        relative_change = abs(current_mean - baseline_mean) / baseline_mean
        return relative_change > threshold
    
    def detect_distribution_drift(self, baseline_samples, current_samples, alpha=0.05):
        """
        分布漂移检测（Kolmogorov-Smirnov检验）
        
        原理：非参数检验，检测两个样本是否来自同一分布
        H0: 两个样本来自同一分布
        若p-value < alpha，拒绝H0，判定为漂移
        """
        from scipy.stats import ks_2samp
        statistic, p_value = ks_2samp(baseline_samples, current_samples)
        return p_value < alpha, p_value
    
    def detect_variance_inflation(self, baseline_std, current_std, threshold=2.0):
        """
        方差膨胀检测
        
        原理：当前标准差超过基线2倍时判定为稳定性严重退化
        """
        return current_std > baseline_std * threshold
```

### 2.4 自适应阈值机制

```
静态阈值的问题：
────────────────
阈值 = 0.8（固定）

业务高峰期：正常波动0.75-0.85 → 频繁误报
业务低谷期：异常值0.79 → 漏报


自适应阈值方案：
────────────────
基线窗口：过去7天同一时段数据
阈值 = mean(基线窗口) - 2 * std(基线窗口)

业务高峰期：基线0.82±0.03 → 阈值0.76
业务低谷期：基线0.88±0.02 → 阈值0.84
```

---

## 🧪 3. 实验验证任务

请运行本目录下的 `test_day06.py`，观察以下关键输出：

### 3.1 基线建立过程
- 黄金数据集加载与验证
- 基线统计特征计算（均值、方差、分布）
- 基线快照保存与加载

### 3.2 漂移检测验证
- 模拟均值漂移场景检测
- 模拟方差膨胀场景检测
- 模拟分布变形场景检测

### 3.3 自适应阈值测试
- 静态阈值 vs 自适应阈值对比
- 不同业务时段的阈值调整
- 误报率/漏报率统计

---

## 📝 4. 产出要求

将运行结果贴回给 Trae，让其生成 `report_day06.md` 质量分析报告。

报告应包含：
1. **基线特征报告**：建立的稳定性基线统计特征
2. **漂移检测结果**：各类漂移场景的检测准确率
3. **阈值优化建议**：静态阈值 vs 自适应阈值的效果对比
4. **生产部署指南**：基线建立与漂移检测的CI/CD集成方案
