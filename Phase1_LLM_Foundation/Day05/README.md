# Day 05: 采样参数与输出稳定性（温度×Top-p网格扫描）

## 🎯 1. 核心风险与测试目标

### 1.1 测试工程师视角
> **核心原则**：开发只管跑通，我们要想办法把它搞崩溃。采样参数的组合效应是输出稳定性的隐形杀手，单一参数测试无法发现组合风险。

### 1.2 业务风险点

| 风险类别 | 具体风险 | 线上事故场景 |
|---------|---------|-------------|
| **参数组合失控** | 温度+Top-p组合导致输出极端不稳定 | 客服机器人同一问题答案差异巨大，用户信任崩塌 |
| **时间维度漂移** | 相同参数配置在不同时间输出不一致 | 夜间低峰期与白天高峰期输出质量差异明显 |
| **边界条件失效** | Top-p接近0或1时的异常行为 | 设置为Top-p=0时系统崩溃或无限循环 |
| **稳定性误判** | 短期测试通过但长期运行失效 | 上线前测试稳定，上线后一周内问题频发 |
| **回退策略缺失** | 参数配置错误时无 graceful degradation | 参数越界导致服务完全不可用 |

### 1.3 测试思路

**参数网格扫描策略**：
- **温度维度**：0, 0.3, 0.7, 1.0, 1.5 —— 覆盖确定性到高创造性
- **Top-p维度**：0.1, 0.5, 0.9, 1.0 —— 覆盖窄核到全词汇表
- **组合爆炸**：5×4=20种组合，验证参数交互效应
- **边界探测**：温度=0, Top-p=0时的极端行为

**时间维度一致性验证**：
- **短时一致性**：1分钟内连续调用10次，验证即时稳定性
- **中时一致性**：1小时内每小时测试，验证小时级漂移
- **温度稳定性**：相同参数多次运行的输出相似度量化

**异常参数探测**：
- **超界值**：温度>2, Top-p>1, 负值参数
- **矛盾组合**：低温+低Top-p（过度限制），高温+高Top-p（过度自由）
- **精度边界**：温度=0.0001, Top-p=0.0001的数值精度问题

---

## 📚 2. 采样参数组合原理（测试必备知识）

### 2.1 温度(Temperature)与Top-p(Nucleus)的协同机制

```
┌─────────────────────────────────────────────────────────────┐
│                    采样参数决策流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   模型输出Logits ──→ 温度缩放 ──→ Softmax ──→ 概率分布      │
│        │                                              │      │
│        │         ┌──────────────────────┐             │      │
│        │         │  温度效应            │             │      │
│        │         │  T→0: 尖锐(确定性)   │             │      │
│        │         │  T→∞: 平坦(随机性)   │             │      │
│        │         └──────────────────────┘             │      │
│        ↓                                              ↓      │
│   概率分布 ──→ Top-p截断 ──→ 重归一化 ──→ 采样空间      │      │
│                    │                                    │      │
│                    ↓                                    ↓      │
│              ┌─────────────┐                    ┌──────────┐  │
│              │ Top-p=0.9   │                    │ 最终采样  │  │
│              │ 取累积概率  │                    │ 选择token │  │
│              │ 前90%词汇   │                    └──────────┘  │
│              └─────────────┘                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 参数组合效应矩阵

| 温度＼Top-p | 0.1 (极窄) | 0.5 (中等) | 0.9 (较宽) | 1.0 (全表) |
|------------|-----------|-----------|-----------|-----------|
| **0 (确定)** | 🔒 极度确定，几乎总是同一输出 | 🔒 高度确定，微小变化 | 🔒 基本确定，偶有变化 | 🔒 确定性采样，固定输出 |
| **0.3 (低随)** | ⚠️ 受限确定，选择极少 | ✅ 稳定可控，推荐配置 | ✅ 稳定多样，平衡良好 | ⚠️ 低随机+全表，略有发散 |
| **0.7 (中随)** | ⚠️ 中等随机但选择受限 | ✅ 创意与稳定平衡 | ⚠️ 随机性明显，需评估 | ⚠️ 高度发散，创意场景 |
| **1.0 (高随)** | ⚠️ 高随机但选择受限，矛盾感 | ⚠️ 明显发散，质量波动 | ⚠️ 高度不稳定 | 🔴 极度发散，生产禁用 |
| **1.5 (极高)** | 🔴 随机+受限，输出质量差 | 🔴 高度不可控 | 🔴 几乎不可用 | 🔴 完全随机，事故风险 |

**关键洞察**：
- 🔒 **确定性区域**：温度≤0.3时，Top-p影响有限，输出稳定
- ✅ **安全区域**：温度0.3-0.7 + Top-p 0.5-0.9，平衡创意与稳定
- ⚠️ **风险区域**：单一参数极端或组合矛盾，需额外验证
- 🔴 **禁区**：温度>1.0且Top-p>0.9，生产环境禁止使用

### 2.3 时间维度稳定性原理

```python
# 时间稳定性测试的核心逻辑

def temporal_stability_test(prompt, params, intervals):
    """
    时间维度一致性验证
    
    风险假设：
    1. 模型热启动效应：冷启动时输出质量不稳定
    2. 负载波动效应：高峰期与低峰期输出差异
    3. 随机种子漂移：相同参数但内部状态变化
    """
    results = []
    for t in intervals:
        response = call_llm(prompt, **params)
        results.append({
            'timestamp': t,
            'response': response,
            'latency': measure_latency(),
        })
    
    # 计算时间维度一致性分数
    consistency_score = calculate_similarity_matrix(results)
    return consistency_score  # 低于阈值则判定为不稳定
```

**时间稳定性风险点**：
1. **热启动偏差**：服务刚启动时的前几次调用质量不稳定
2. **负载敏感**：高并发时采样随机性可能受影响
3. **缓存污染**：CDN或模型缓存导致非预期的一致性

### 2.4 参数边界风险

| 参数值 | 风险描述 | 预期行为 | 实际风险 |
|-------|---------|---------|---------|
| temperature=0 | 理论上确定性输出 | Greedy decoding | 部分实现仍有微小随机性 |
| temperature<0 | 数学上无意义 | 应报错或截断 | 可能未校验导致异常 |
| temperature>2 | 过度平坦的分布 | 高度随机 | 可能产生无意义输出 |
| top_p=0 | 空采样集 | 应报错 | 可能死循环或崩溃 |
| top_p<0 | 数学上无意义 | 应报错 | 可能未校验 |
| top_p>1 | 超出概率范围 | 应等同于1 | 可能未处理 |

---

## 🧪 3. 实验验证任务

请运行本目录下的 `test_day05.py`，观察以下关键输出：

### 3.1 参数网格扫描结果
- 20种参数组合的输出多样性热力图
- 高风险组合（🔴）识别与标记
- 推荐生产配置（✅）

### 3.2 时间稳定性报告
- 10次连续调用的输出相似度矩阵
- 变异系数(CV)计算
- 稳定性评级（稳定/波动/失控）

### 3.3 边界条件验证
- 极端参数值的系统响应
- 错误处理与降级策略验证
- 异常输入的容错能力

---

## 📝 4. 产出要求

将运行结果贴回给 Trae，让其生成 `report_day05.md` 质量分析报告。

报告应包含：
1. **参数-质量响应曲面图**：温度×Top-p的组合效应可视化
2. **稳定性评级矩阵**：各组合的稳定性等级划分
3. **生产配置建议**：基于测试结果的安全参数区间
4. **风险清单**：识别的高风险参数组合与规避策略
